CC      = vc
VASM    = vasmm68k_mot
VLINK   = vlink
LDFLAGS = -stdlib
CONFIG  = +aos68k
ODIR    = build-vbcc

SRC_EXE     := src/test.c
SRC_LIBRARY := src/StartUp.c src/LibInit.c
# Filter out all specific sources from the common wildcard-ed sources.
SRC_COMMON  := $(filter-out $(SRC_EXE) $(SRC_LIBRARY),$(wildcard src/*.c))
SRC_C        = $(SRC_EXE) $(SRC_COMMON)
SRC_S        = $(wildcard src/*.s)

EXE = uae/dh0/test
_OBJ = $(SRC_C:.c=.o) $(SRC_S:.s=.o)
#_OBJ = test.o c2p_mul_by_ten.o
OBJ = $(patsubst %,$(ODIR)/%,$(_OBJ))

# Prepare variables for target 'clean'
ifeq ($(OS),Windows_NT)
	RM:=del
	PATHSEP:=\\
	CONFIG:=${CONFIG}_win
else
	RM:=rm -f 
	PATHSEP:=/
endif

all:
	$(MAKE) clean
	$(MAKE) exe

exe: $(EXE)

$(EXE) : $(OBJ) 
	$(VLINK) -bamigahunk -x -Bstatic -Cvbcc -nostdlib $(VBCC)/targets/m68k-amigaos/lib/startup.o $(OBJ) -L$(VBCC)/targets/m68k-amigaos/lib -lvc -lamiga -mrel -o $(EXE)
#	$(VLINK) -bamigahunk -x -Bstatic -Cvbcc -nostdlib $(VBCC)/targets/m68k-amigaos/lib/startup.o $(OBJ) -L$(VBCC)/targets/m68k-amigaos/lib -lvc -o $(EXE)

$(ODIR)/%.o : %.c
	$(CC) $(CONFIG) -g -c -c99 -O3 -speed -cpp-comments -sd -sc -o $@ $<
# usare il parametro -k per mantenere i file .asm generati dal compilatore
#	$(CC) $(CONFIG) -g -c -c99 -O3 -speed -cpp-comments -sd -sc -k -o $@ $<
#	$(CC) $(CONFIG) -g -c -o $@ $<

$(ODIR)/%.o : %.s
	$(VASM) -quiet -m68030 -Fhunk -linedebug -o $@ $<


clean:
	-$(RM) $(ODIR)$(PATHSEP)*.o
	-$(RM) $(subst /,$(PATHSEP),$(EXE))
